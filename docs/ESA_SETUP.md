# 阿里云 ESA 初始化配置指南

本文档介绍如何从零开始开通和配置阿里云 ESA（Edge Security Acceleration）服务。

## 📋 什么是阿里云 ESA

阿里云 ESA 是新一代边缘安全加速服务，提供：

- **全球边缘节点**：覆盖全球的 CDN 加速
- **边缘计算**：在边缘节点运行 JavaScript 代码
- **边缘存储**：EdgeKV 键值存储服务
- **安全防护**：DDoS、WAF 等安全能力

## 🚀 开通 ESA 服务

### 步骤 1：注册阿里云账号

1. 访问阿里云官网：https://www.aliyun.com/
2. 点击"免费注册"
3. 完成实名认证（企业或个人）

### 步骤 2：开通 ESA 服务

1. **访问 ESA 产品页**
   - https://www.aliyun.com/product/esa

2. **点击"立即开通"**
   - 阅读服务协议
   - 勾选同意并开通

3. **选择计费方式**
   - **按量付费**：适合初期测试
   - **包年包月**：适合长期使用
   
4. **确认开通**
   - 点击"立即购买"
   - 完成支付（如适用）

## 🌐 域名接入配置

### 准备工作

- 拥有一个已备案的域名（中国大陆）
- 或国际域名（海外节点）
- 域名 DNS 管理权限

### 接入方式选择

ESA 提供两种域名接入方式：

#### 方式 1：NS 接入（推荐）

**优点**：
- 功能完整，支持所有特性
- 自动管理 DNS 记录
- 配置简单

**缺点**：
- 需要修改域名 NS 服务器
- 影响整个域名

**步骤**：

1. **添加站点**
   - 进入 ESA 控制台
   - 点击"添加站点"
   - 输入域名（如 `example.com`）
   - 选择"NS 接入"
   - 点击"下一步"

2. **修改 NS 记录**
   - ESA 会提供 2 个 NS 服务器地址
   - 登录域名注册商控制台
   - 修改域名的 NS 记录为 ESA 提供的地址
   - 等待 DNS 生效（通常 24-48 小时）

3. **验证接入**
   - 回到 ESA 控制台
   - 点击"验证"
   - 等待验证成功

#### 方式 2：CNAME 接入

**优点**：
- 不影响现有 DNS 配置
- 灵活，可只接入部分子域名

**缺点**：
- 部分高级功能受限
- 需要手动管理 DNS 记录

**步骤**：

1. **添加站点**
   - 进入 ESA 控制台
   - 点击"添加站点"
   - 输入域名
   - 选择"CNAME 接入"
   - 点击"下一步"

2. **添加 CNAME 记录**
   - ESA 会提供 CNAME 目标地址
   - 在域名 DNS 服务商处添加记录：
     ```
     类型: CNAME
     主机记录: www（或其他子域名）
     记录值: <ESA提供的CNAME地址>
     TTL: 600
     ```

3. **验证接入**
   - 等待 DNS 生效
   - ESA 自动验证

### 配置 SSL 证书

1. **自动证书（推荐）**
   - ESA 默认提供免费 SSL 证书
   - 自动申请和续期
   - 无需额外配置

2. **自定义证书**
   - 如果有自己的证书
   - 在"SSL/TLS"页面上传
   - 支持单域名、通配符、多域名证书

## ⚙️ 基础配置

### 1. 开启 HTTPS

1. **强制 HTTPS**
   - 左侧菜单：SSL/TLS
   - 开启"HTTPS 强制跳转"
   - 所有 HTTP 请求自动跳转到 HTTPS

2. **HSTS**（可选）
   - 开启 HSTS（HTTP Strict Transport Security）
   - 增强安全性

### 2. 配置缓存规则

1. **默认缓存**
   - 左侧菜单：缓存配置
   - 查看默认缓存规则

2. **自定义规则**（可选）
   - 静态资源（.js/.css/.jpg 等）：长时间缓存
   - 动态内容：不缓存或短时间缓存

### 3. 性能优化

1. **开启压缩**
   - 左侧菜单：性能优化
   - 开启 Gzip/Brotli 压缩
   - 减少传输大小

2. **HTTP/2**
   - 自动启用 HTTP/2
   - 提升加载速度

3. **HTTP/3（QUIC）**（可选）
   - 开启 HTTP/3 支持
   - 进一步优化性能

## 🛡️ 安全配置

### 1. 基础防护

1. **DDoS 防护**
   - 默认开启
   - 自动防御 DDoS 攻击

2. **CC 防护**
   - 防御 CC 攻击（Challenge Collapsar）
   - 可自定义防护规则

### 2. WAF 防护（可选）

1. **开启 WAF**
   - 左侧菜单：安全防护 → WAF
   - 开启 Web 应用防火墙

2. **配置规则**
   - SQL 注入防护
   - XSS 防护
   - 自定义规则

### 3. 访问控制

1. **IP 黑白名单**（可选）
   - 限制特定 IP 访问
   - 或只允许特定 IP 访问

2. **地域访问控制**（可选）
   - 限制特定国家/地区访问

## 🔧 边缘计算配置

### 1. 启用边缘函数

1. **进入函数管理**
   - 左侧菜单：边缘计算 → 函数和 Pages

2. **创建函数**
   - 参考 [DEPLOYMENT.md](DEPLOYMENT.md)

### 2. 启用边缘存储

1. **进入存储管理**
   - 左侧菜单：边缘计算 → 边缘存储

2. **创建存储空间**
   - 创建 `html_pages` Namespace
   - 用于存储生成的 HTML 页面

## 📊 监控和日志

### 1. 实时监控

1. **查看监控数据**
   - 左侧菜单：监控中心
   - 实时流量、带宽、请求数

2. **告警配置**（可选）
   - 配置告警规则
   - 异常时短信/邮件通知

### 2. 日志分析

1. **访问日志**
   - 左侧菜单：日志中心 → 访问日志
   - 查看详细的访问记录

2. **边缘函数日志**
   - 左侧菜单：日志中心 → 函数日志
   - 查看函数执行日志

## 💰 费用说明

### 计费项目

1. **流量费用**
   - 按实际产生的流量计费
   - 分国内和海外流量

2. **请求费用**
   - 按请求次数计费
   - 边缘函数额外计费

3. **边缘存储费用**
   - 按存储容量计费
   - 按读写次数计费

### 费用优化

1. **合理配置缓存**
   - 减少回源流量
   - 降低流量费用

2. **开启压缩**
   - 减少传输大小
   - 降低流量费用

3. **按需使用**
   - 初期使用按量付费
   - 稳定后考虑包年包月

## ❗ 常见问题

### 1. 域名接入后无法访问

**原因**：DNS 未生效或配置错误

**解决**：
- 使用 `nslookup` 或 `dig` 检查 DNS
- 等待 DNS 完全生效（最长 48 小时）
- 检查源站是否正常

### 2. SSL 证书错误

**原因**：证书未生效或配置错误

**解决**：
- 等待自动证书签发（通常几分钟）
- 检查域名验证是否通过
- 使用自定义证书并正确配置

### 3. 边缘函数无法使用

**原因**：服务未开通或权限不足

**解决**：
- 确认已开通边缘计算服务
- 检查账号权限
- 查看函数运行日志

## 📞 获取帮助

### 官方资源

- **产品文档**：https://help.aliyun.com/zh/esa/
- **API 文档**：https://help.aliyun.com/zh/esa/developer-reference/
- **最佳实践**：https://help.aliyun.com/zh/esa/best-practices/

### 技术支持

- **工单系统**：登录阿里云控制台提交工单
- **客服电话**：95187
- **开发者社区**：https://developer.aliyun.com/ask/

---

完成以上配置后，您就可以开始部署边缘函数了！请继续参考 [DEPLOYMENT.md](DEPLOYMENT.md) 完成具体的部署步骤。
